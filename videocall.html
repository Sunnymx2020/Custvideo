<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ChatNXT Video Call</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #0d1117, #161b22, #21262d);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color: #fff;
      overflow: hidden;
    }

    #controls {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(12px);
      border-radius: 24px;
      padding: 40px;
      text-align: center;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 10;
      transition: opacity 0.3s ease;
    }

    #controls h2 {
      margin: 0 0 20px;
      font-size: 24px;
      font-weight: 600;
      color: #e6edf3;
    }

    #controls input, #controls button {
      width: 100%;
      padding: 14px;
      margin: 12px 0;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
    }

    #controls input {
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      padding-left: 16px;
    }

    #controls input::placeholder {
      color: #8b949e;
    }

    #controls input:focus {
      box-shadow: 0 0 10px rgba(0, 123, 255, 0.5);
    }

    #controls button {
      background: linear-gradient(90deg, #00c6ff, #0072ff);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    #controls button:hover {
      background: linear-gradient(90deg, #00aaff, #0056ff);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    #controls button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    #status {
      font-size: 14px;
      color: #d1d5db;
      margin-top: 12px;
      transition: color 0.3s ease;
    }

    #video-container {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: none;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      background: #000;
    }

    #localVideo {
      width: 160px;
      height: 200px;
      position: absolute;
      bottom: 30px;
      right: 30px;
      z-index: 3;
      border-radius: 16px;
      border: 3px solid #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    #call-controls {
      position: absolute;
      bottom: 40px;
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 20px;
      z-index: 4;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 16px;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn img {
      width: 28px;
      height: 28px;
      filter: invert(100%) brightness(1.2);
    }

    .end-btn {
      background: linear-gradient(90deg, #ff4d4f, #cf1322);
    }

    .end-btn:hover {
      background: linear-gradient(90deg, #e63946, #b1121f);
    }

    .share-link-container {
      margin-top: 15px;
      width: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
    }

    .share-link {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border-radius: 10px;
      border: none;
      background: rgba(255, 255, 255, 0.1);
      color: #e6edf3;
      word-break: break-all;
      text-align: center;
    }

    @media (max-width: 600px) {
      #controls {
        padding: 20px;
        max-width: 90%;
      }
      #localVideo {
        width: 120px;
        height: 160px;
      }
      .control-btn {
        width: 50px;
        height: 50px;
      }
      .control-btn img {
        width: 24px;
        height: 24px;
      }
    }
  </style>
</head>
<body>

<div id="controls">
  <h2>ChatNXT Secure Call</h2>
  <input type="text" id="roomId" placeholder="Room ID (alphanumeric only)">
  <input type="password" id="roomPass" placeholder="Password">
  <button onclick="createRoom()">Create Room</button>
  <button onclick="joinRoom()">Join Room</button>
  <div id="status">Ready</div>
  <div class="share-link-container" id="shareLinkContainer">
    <input type="text" class="share-link" id="shareLink" readonly>
    <button onclick="copyLink()">Copy Link</button>
  </div>
</div>

<div id="video-container">
  <video id="remoteVideo" autoplay playsinline></video>
  <video id="localVideo" autoplay muted playsinline></video>

  <div id="call-controls">
    <button class="control-btn" onclick="toggleMic()">
      <img src="https://www.svgrepo.com/show/489365/microphone.svg" alt="Mic">
    </button>
    <button class="control-btn" onclick="shareRoom()">
      <img src="https://www.svgrepo.com/show/489349/share.svg" alt="Share">
    </button>
    <button class="control-btn end-btn" onclick="endCall()">
      <img src="https://www.svgrepo.com/show/489351/close.svg" alt="End Call">
    </button>
  </div>
</div>

<script>
  let peer, call, localStream, micOn = true;
  let room = "", password = "";
  let connectionRetries = 0;
  const maxRetries = 3;

  function logStatus(txt) {
    document.getElementById("status").innerText = txt;
    console.log("Status:", txt);
  }

  function hideControls() {
    document.getElementById("controls").style.display = "none";
    document.getElementById("video-container").style.display = "block";
  }

  function showShareLink() {
    const shareLink = `${location.origin}${location.pathname}?room=${encodeURIComponent(room)}|${encodeURIComponent(password)}`;
    document.getElementById("shareLink").value = shareLink;
    document.getElementById("shareLinkContainer").style.display = "flex";
  }

  function copyLink() {
    const shareLink = document.getElementById("shareLink");
    shareLink.select();
    document.execCommand("copy");
    logStatus("Link copied to clipboard!");
    setTimeout(() => logStatus("Connected"), 2000);
  }

  function validateRoomId(rid) {
    const isValid = /^[a-zA-Z0-9_-]+$/.test(rid);
    return isValid;
  }

  async function createRoom() {
    const rid = document.getElementById("roomId").value.trim();
    const pass = document.getElementById("roomPass").value.trim();
    if (!rid || !pass) {
      logStatus("Please enter both Room ID and Password");
      return;
    }

    if (!validateRoomId(rid)) {
      logStatus("Room ID must be alphanumeric (letters, numbers, _, - only)");
      return;
    }

    password = pass;
    room = btoa(rid); // Encode room ID to avoid special characters

    try {
      peer = new Peer(room, {
        host: 'peerjs-server.herokuapp.com',
        port: 443,
        secure: true,
        debug: 2
      });

      peer.on('open', async () => {
        console.log("PeerJS connection opened with ID:", room);
        logStatus("Waiting for someone to join...");
        connectionRetries = 0;
        await startCamera();
        hideControls();
        showShareLink();
      });

      peer.on('error', (err) => {
        console.error("PeerJS error:", err.type, err.message);
        if (err.type === 'peer-unavailable' && connectionRetries < maxRetries) {
          connectionRetries++;
          logStatus(`Retrying connection (${connectionRetries}/${maxRetries})...`);
          setTimeout(createRoom, 2000);
        } else if (err.type === 'invalid-id') {
          logStatus("Invalid Room ID. Use alphanumeric characters only.");
        } else {
          logStatus(`Failed to create room: ${err.message}`);
        }
      });

      peer.on('call', incomingCall => {
        call = incomingCall;
        incomingCall.answer(localStream);
        incomingCall.on('stream', stream => {
          document.getElementById("remoteVideo").srcObject = stream;
          logStatus("Connected");
        });
        incomingCall.on('error', (err) => {
          console.error("Call error:", err);
          logStatus("Call error occurred");
        });
      });

      peer.on('disconnected', () => {
        console.log("PeerJS disconnected");
        if (connectionRetries < maxRetries) {
          connectionRetries++;
          logStatus(`Reconnecting (${connectionRetries}/${maxRetries})...`);
          peer.reconnect();
        } else {
          logStatus("Connection lost. Please try again.");
        }
      });
    } catch (err) {
      console.error("Create room error:", err);
      logStatus("Error creating room. Please try again.");
    }
  }

  async function joinRoom() {
    const rid = document.getElementById("roomId").value.trim();
    let pass = document.getElementById("roomPass").value.trim();
    if (!rid) {
      logStatus("Please enter Room ID");
      return;
    }

    if (!validateRoomId(rid)) {
      logStatus("Room ID must be alphanumeric (letters, numbers, _, - only)");
      return;
    }

    if (!pass) {
      pass = prompt("Enter the room password:");
      if (!pass) {
        logStatus("Password is required");
        return;
      }
    }

    password = pass;
    room = btoa(rid);

    try {
      peer = new Peer({
        host: 'peerjs-server.herokuapp.com',
        port: 443,
        secure: true,
        debug: 2
      });

      peer.on('open', async () => {
        console.log("PeerJS join opened");
        hideControls();
        await startCamera();
        call = peer.call(room, localStream);
        if (call) {
          call.on('stream', stream => {
            document.getElementById("remoteVideo").srcObject = stream;
            logStatus("Connected");
          });
          call.on('error', (err) => {
            console.error("Call error:", err);
            logStatus("Failed to connect to room");
          });
        } else {
          logStatus("Failed to connect to room. Check Room ID and Password.");
        }
      });

      peer.on('error', (err) => {
        console.error("PeerJS error:", err.type, err.message);
        logStatus(`Failed to join room: ${err.type === 'peer-unavailable' ? 'Invalid Room ID or Password' : err.message}`);
      });

      peer.on('disconnected', () => {
        console.log("PeerJS disconnected");
        if (connectionRetries < maxRetries) {
          connectionRetries++;
          logStatus(`Reconnecting (${connectionRetries}/${maxRetries})...`);
          peer.reconnect();
        } else {
          logStatus("Connection lost. Please try again.");
        }
      });
    } catch (err) {
      console.error("Join room error:", err);
      logStatus("Error joining room. Please try again.");
    }
  }

  async function startCamera() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      document.getElementById("localVideo").srcObject = localStream;
    } catch (err) {
      console.error("Camera error:", err);
      logStatus("Failed to access camera/mic. Check permissions.");
      throw err;
    }
  }

  function toggleMic() {
    if (localStream) {
      micOn = !micOn;
      localStream.getAudioTracks()[0].enabled = micOn;
      logStatus(micOn ? "Mic On" : "Mic Off");
    }
  }

  function shareRoom() {
    showShareLink();
    copyLink();
  }

  function endCall() {
    if (call) call.close();
    if (peer) peer.destroy();
    if (localStream) localStream.getTracks().forEach(t => t.stop());
    location.reload();
  }

  const params = new URLSearchParams(location.search);
  if (params.has("room")) {
    const roomParam = params.get("room");
    const split = roomParam.split("|");
    if (split.length >= 1) {
      document.getElementById("roomId").value = split[0];
      document.getElementById("roomPass").value = split[1] || "";
      joinRoom();
    }
  }
</script>
</body>
</html>
